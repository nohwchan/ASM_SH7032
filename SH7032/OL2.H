;********************************************
;--------CHECK CL AND OL2 TRIP--------------*
;********************************************
;	MOV FLGSYS,R0
;	ADD #1,R0
;	MOV.B @R0,R0
;	TST #B'100,R0
;	BF  NO_CL

	MOV IMOTOR,R0
	MOV @R0,R0
	MOV #15,R1
	MULS R0,R1
	STS MACL,R0
        MOV #10,R2              ;IMPROVE2(R1-->R2)
        DIVSN R2,R0             ;R0=1.5*IMOTOR(RATED);IMPROVE2(DIVS-->DIVSN)
        MOV IRMS,R1
	MOV @R1,R1		;R1=IRMS REAL

	CMP/GE R0,R1		;IF RMS < 1.5*IMOTOR
	BF  NO_CL		;THEN NO_CL
	MOV CL_COUNT,R1		
	MOV @R1,R0
	ADD #1,R0		;INCREASE CL_COUNTER 1ms
	MOV R0,@R1
	BRA OL2_CHK
	NOP
NO_CL:
	MOV CL_COUNT,R1
	MOV #0,R0		;CLEAR CL_COUNTER
	MOV R0,@R1		

OL2_CHK:

	MOV OL2_COUNT,R1	
	MOV.B @R1,R0		
	ADD #1,R0		;COUNT EVERY 1 ms. 
	MOV.B R0,@R1		

	CMP/EQ #100,R0		;IF COUNTER = 100 ms.
	BF  OUTOL2
	MOV #0,R0		;THEN CLEAR COUNTER
	MOV R0,@R1
	BRA DERATE_CHK
	NOP
OUTOL2:
	BRA OUT_OL2
	NOP

DERATE_CHK:
	MOV IMOTOR,R3
	MOV @R3,R3		;R3=IMOTOR (% OF I_INV)

	MOV S_STATUS1,R0
	MOV.B @R0,R0
	TST #B'10,R0		;IF FLAT RATE IS SELECT 
	BT  FLAT_RATE		;THEN FLAT_RATE

	MOV FREQRUN,R0
	MOV.W @R0,R0		;R0=FRUN

	MOV F512,R1
	CMP/GT R1,R0		;IF FRUN = 0-5.12 Hz 
	BT  DERATE70		
	MOV P620,R2		;THEN DERATE 62 %
	BRA END_DERATE
	NOP
DERATE70:
	MOV F1024,R1
	CMP/GT R1,R0		;IF FRUN = 5.13-10.24 Hz
	BT DERATE80
	MOV P700,R2		;THEN DERATE 70 %
	BRA END_DERATE
	NOP
DERATE80:
	MOV F1536,R1
	CMP/GT R1,R0		;IF FRUN = 10.25-15.36 Hz
	BT  DERATE86
	MOV P800,R2		;THEN DERATE 80 %
	BRA END_DERATE
	NOP
DERATE86:
	MOV F2048,R1
	CMP/GT R1,R0		;IF FRUN = 15.37-20.48 Hz
	BT DERATE91
	MOV P860,R2		;THEN DERATE 86 %
	BRA END_DERATE
	NOP
DERATE91:
	MOV F2560,R1
	CMP/GT R1,R0		;IF FRUN = 20.49-25.60 Hz
	BT  DERATE93
	MOV P916,R2		;THEN DERATE 91.6 %
	BRA END_DERATE
	NOP
DERATE93:
	MOV F3072,R1
	CMP/GT R1,R0		;IF FRUN = 25.61-30.72 Hz
	BT DERATE95
	MOV P933,R2		;THEN DERATE 93.3 %
	BRA END_DERATE
	NOP
DERATE95: 
	MOV F3584,R1
	CMP/GT R1,R0		;IF FRUN = 30.73-35.84 Hz
	BT  DERATE96
	MOV P950,R2		;THEN DERATE 95.0 %
	BRA END_DERATE
	NOP
DERATE96:
	MOV F4096,R1
	CMP/GT R1,R0		;IF FRUN = 35.85-40.96 Hz
	BT DERATE98
	MOV P967,R2		;THEN DERATE 96.7 %
	BRA END_DERATE
	NOP
DERATE98:
	MOV F4608,R1
	CMP/GT R1,R0		;IF FRUN = 40.97-46.08 Hz
	BT  DERATE100
	MOV P983,R2		;THEN DERATE 98.3 %
	BRA END_DERATE
	NOP
DERATE100:
	MOV P1000,R2		;WHEN FRUN > 46.08 THEN DERATE 100%(NOT DERATE)
END_DERATE:
	MULS R2,R3
	STS MACL,R3
	MOV P1000,R2
	DIVS R2,R3		;R3 = (IMOTOR*%DERATE)/100

	MOV IDERATE,R2
	MOV R3,@R2
FLAT_RATE:
	MOV IRMS,R2
	MOV @R2,R2		;R2=IRMS(SCALE 100)
	MOV SUMOL,R1
	MOV @R1,R0		;R0=SUMOL
	CMP/GT R3,R2		;IF IRMS > IDERATE
	BF  COOL	
	MOV SC256,R5		;THEN INCREASE SUMOL
;IMPROVE2
SHAR R2
;IMPROVE2
        MULS R2,R5
	STS MACL,R2		;R2=256*IRMS
;IMPROVE2
SHAL R2
;IMPROVE2
        DIVS R3,R2              ;R2=(256*IRMS)/IDERATE
	MULS R2,R2		
	STS MACL,R2		;R2=[(256*IRMS)/IDERATE]^2
	MOV SC65536,R3
	SUB R3,R2		;R2=[(256*IRMS)/IDERATE]^2-(256)^2
	ADD R2,R0		;INCREASE SUMOL
	MOV R0,@R1
	BRA OUT_OL2
	NOP
COOL:
	MOV #0,R4
	CMP/GT R4,R0		;IF SUMOL </= 0 
	BF  LESS_ZERO		;THEN LESS_ZERO
	MOV COOL_STEP,R2
	SUB R2,R0		;DECREASE SUMOL
	MOV R0,@R1
	BRA OUT_OL2
	NOP
LESS_ZERO:
	MOV R4,@R1
	BRA OUT_OL2
	NOP

	.ALIGN 4
MCSPEED:	.DATA.L MC_SPEED	;VARIABLE IN S.MAC
MCLAST3:	.DATA.L MC_LAST		;VARIABLE IN S.MAC
CL_COUNT:       .DATA.L _CL_COUNT
OL2_COUNT:      .DATA.L _OL2_COUNT
IRMS:		.DATA.L I_RMS
SUMOL:		.DATA.L SUM_OL
IDERATE:	.DATA.L I_DERATE
IMOTOR:		.DATA.L I_MOTOR
FREQRUN:	.DATA.L FRUN
S_STATUS1:	.DATA.L _S_STATUS
SC65536:	.DATA.L 65536
COOL_STEP:	.DATA.L 87381
F512:		.DATA.L 512
F1024:		.DATA.L 1024
F1536:		.DATA.L 1536
F2048:		.DATA.L 2048
F2560:		.DATA.L 2560
F3072:		.DATA.L 3072
F3584:		.DATA.L 3584
F4096:		.DATA.L 4096
F4608:		.DATA.L 4608
P620:		.DATA.L 620
P700:		.DATA.L 700
P800:		.DATA.L 800
P860:		.DATA.L 860
P916:		.DATA.L 916
P933:		.DATA.L 933
P950:		.DATA.L 950
P967:		.DATA.L 967
P983:		.DATA.L 983
P1000:		.DATA.L 1000
SC256:		.DATA.L 256
	.ALIGN 4
OUT_OL2:
	
